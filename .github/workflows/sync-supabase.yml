name: Sync Supabase to Markdown

on:
  # Executa quando há um webhook do Supabase
  repository_dispatch:
    types: [supabase-post-created, supabase-post-updated, supabase-series-created]
  
  # Permite execução manual via GitHub UI
  workflow_dispatch:
  
  # Executa automaticamente a cada 15 minutos (fallback se webhook falhar)
  schedule:
    - cron: '*/15 * * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Debug - Check environment variables
        run: |
          echo "SUPABASE_URL is set: $([[ -n "${{ secrets.SUPABASE_URL }}" ]] && echo "✓ Yes" || echo "✗ No")"
          echo "SUPABASE_SERVICE_ROLE_KEY is set: $([[ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]] && echo "✓ Yes" || echo "✗ No")"
        shell: bash
      
      - name: Sync Supabase to Markdown
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: node scripts/sync-supabase-to-markdown.js
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code _posts/ || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push if changed
        if: steps.git-check.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _posts/
          git commit -m "docs: sync posts from Supabase [skip ci]"
          gh repo sync guiibrag4/Divine-Insights --source main
          git push origin main
      
      - name: No changes detected
        if: steps.git-check.outputs.changed != 'true'
        run: echo "✅ No changes detected. Markdown files are up to date."
